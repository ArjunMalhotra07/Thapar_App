name: Build APK and Send Download Link

on:
  workflow_dispatch:  # Manual trigger only
  # Or use this for automatic builds:
  # push:
  #   branches: [ main ]  # Triggers on every push to main branch

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.2'
          
      - name: Get Flutter dependencies
        run: flutter pub get
        
      - name: Build APK
        run: flutter build apk --release
        
      - name: Get current timestamp
        id: timestamp
        run: echo "timestamp=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
        
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "build-${{ steps.timestamp.outputs.timestamp }}"
          release_name: "APK Build ${{ steps.timestamp.outputs.timestamp }}"
          body: |
            Automated APK build generated on ${{ steps.timestamp.outputs.timestamp }}
            
            Download the APK below and install on your Android device.
          draft: false
          prerelease: false
          
      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: build/app/outputs/flutter-apk/app-release.apk
          asset_name: app-release-${{ steps.timestamp.outputs.timestamp }}.apk
          asset_content_type: application/vnd.android.package-archive
          
      - name: Send Email with Download Link
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸ“± New APK Build Available - ${{ steps.timestamp.outputs.timestamp }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_USERNAME }}
          html_body: |
            <h2>ðŸš€ New APK Build Ready!</h2>
            <p><strong>Build Time:</strong> ${{ steps.timestamp.outputs.timestamp }}</p>
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Download Link:</strong></p>
            <p><a href="https://github.com/${{ github.repository }}/releases/tag/build-${{ steps.timestamp.outputs.timestamp }}" style="background-color: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">ðŸ“± Download APK from GitHub</a></p>
            <p><small>Click the link above to go to the release page, then download the APK file.</small></p>